<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>最近傍点検索（PRO / RES）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; max-width:860px; margin:24px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 10px;}
    .help{color:#555; font-size:14px; margin:0 0 14px; line-height:1.6;}
    label{display:block; margin:10px 0 6px; font-weight:700;}
    input{width:100%; padding:10px 12px; font-size:16px; border:1px solid #ccc; border-radius:10px;}
    .rowline{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;}
    select{padding:10px 12px; font-size:16px; border:1px solid #ccc; border-radius:10px;}
    button{padding:10px 14px; font-size:16px; border:0; border-radius:10px; cursor:pointer;}
    .card{margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:12px;}
    .row{margin:6px 0;}
    .err{color:#b00020; font-weight:800;}
    code{background:#f6f8fa; padding:2px 6px; border-radius:6px;}
    .badge{display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:14px; margin-left:6px;}
    .hr{height:1px; background:#eee; margin:10px 0;}
    details{border:1px dashed #ccc; border-radius:12px; padding:10px 12px; margin-top:14px;}
    summary{cursor:pointer; font-weight:700;}
    ul{margin:8px 0 0 18px;}
    .muted{color:#666; font-size:13px;}
  </style>
</head>
<body>
  <h1>最近傍点検索（PRO / RES）</h1>
  <p class="help">
    入力形式：<code>35.88446158066726, 139.4528218383903</code>（緯度, 経度）<br/>
    出力：最近接点（都道府県名 or 点ID）＋距離（km）＋判定
  </p>

  <label for="coord">緯度, 経度</label>
  <input id="coord" placeholder='例: 35.88446158066726, 139.4528218383903' />

  <div class="rowline">
    <label style="margin:0; font-weight:700;">検索モード</label>
    <select id="mode">
      <option value="PRO">PRO</option>
      <option value="RES">RES</option>
      <option value="BOTH" selected>両方</option>
    </select>
    <button id="btn">検索</button>
    <span class="muted">Enterでも検索</span>
  </div>
  
  <div id="out" class="card" style="display:none;"></div>

  <script>
    // =========================
    // PRO/RES 設定
    // =========================

const CONFIG = {
  PRO: {
    pointsFile: "./PROpoints.json",
    // <30 / 30-40 / 40-50 / >=50 （すべて「未満/以上」ルール）
    judge: (km) => {
      if (km < 30) return "◎（30km未満）";
      if (km < 40) return "〇（30km以上、40km未満）";
      if (km < 50) return "要現地調査（40km以上、50km未満）";
      return "非推奨（50km以上）";
    }
  },
  RES: {
    pointsFile: "./RESpoints.json",
    // <40 / 40-50 / 50-60 / >=60
    judge: (km) => {
      if (km < 40) return "◎（40km未満）";
      if (km < 50) return "〇（40km以上、50km未満）";
      if (km < 60) return "要現地調査（50km以上、60km未満）";
      return "非推奨（60km以上）";
    }
  }
};

    

    // ===== Core geo =====
    const R = 6371000; // meters
    const toRad = (deg) => deg * Math.PI / 180;

    function haversineMeters(lat1, lng1, lat2, lng2) {
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const dφ = toRad(lat2 - lat1);
      const dλ = toRad(lng2 - lng1);
      const a = Math.sin(dφ/2)**2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(dλ/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function parseLatLngLine(s) {
      if (!s) return { lat: null, lng: null, error: "入力が空です" };
      const parts = String(s).trim().split(",");
      if (parts.length !== 2) return { lat: null, lng: null, error: "形式は「緯度, 経度」です（カンマ区切り）" };

      const lat = Number(parts[0].trim());
      const lng = Number(parts[1].trim());
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return { lat: null, lng: null, error: "緯度経度は数値で入力してください" };
      if (lat < -90 || lat > 90) return { lat: null, lng: null, error: "緯度は -90〜90 です" };
      if (lng < -180 || lng > 180) return { lat: null, lng: null, error: "経度は -180〜180 です" };
      return { lat, lng, error: null };
    }

    function formatKm(meters) {
      return (meters / 1000).toFixed(3);
    }

    // ===== Data loading (cached) =====
    const pointsCache = { PRO: null, RES: null };

    async function loadPoints(which) {
      if (pointsCache[which]) return pointsCache[which];

      const res = await fetch(CONFIG[which].pointsFile, { cache: "no-store" });
      if (!res.ok) throw new Error(`${which}: 候補点ファイルが読み込めませんでした`);
      const pts = await res.json();
      if (!Array.isArray(pts) || pts.length === 0) throw new Error(`${which}: 候補点が空です`);
      pointsCache[which] = pts;
      return pts;
    }

    async function findNearest(which, lat, lng) {
      const points = await loadPoints(which);

      let best = null;
      for (const p of points) {
        if (typeof p.lat !== "number" || typeof p.lng !== "number") continue;
        const d = haversineMeters(lat, lng, p.lat, p.lng);
        if (!best || d < best.distance_m) best = { point: p, distance_m: d };
      }
      if (!best) throw new Error(`${which}: 有効な候補点がありません`);
      return best;
    }

    function displayName(point) {
      // PROはprefがある前提、RESはidのみでも動く
      return point.name ?? point.pref ?? point.id ?? "(no name)";
    }

function renderBlock(which, name, km, verdictText) {
  return `
    <div class="row"><b>${which} 最近接点:</b> ${name}</div>
    <div class="row"><b>${which} 距離:</b> ${km.toFixed(3)} km</div>
    <div class="row"><b>${which} 判定:</b> ${verdictText}</div>
  `;
}



    // ===== UI =====
    const out = document.getElementById("out");
    const input = document.getElementById("coord");
    const mode = document.getElementById("mode");

    async function run() {
      out.style.display = "block";
      out.innerHTML = "計算中…";

const parsed = parseLatLngLine(input.value);
if (parsed.error) {
  out.innerHTML = `<div class="err">${parsed.error}</div>`;
  return;
}

      const m = mode.value;

      try {
        if (m === "PRO") {
          const r = await findNearest("PRO", parsed.lat, parsed.lng);
          const km = r.distance_m / 1000;
          out.innerHTML = renderBlock("PRO", displayName(r.point), km, CONFIG.PRO.judge(km));
          return;
        }

        if (m === "RES") {
          const r = await findNearest("RES", parsed.lat, parsed.lng);
          const km = r.distance_m / 1000;
          out.innerHTML = renderBlock("RES", displayName(r.point), km, CONFIG.RES.judge(km));
          return;
        }

        // BOTH
        const [p, r] = await Promise.all([
          findNearest("PRO", parsed.lat, parsed.lng),
          findNearest("RES", parsed.lat, parsed.lng),
        ]);

        const kmP = p.distance_m / 1000;
        const kmR = r.distance_m / 1000;

        out.innerHTML = `
          ${renderBlock("PRO", displayName(p.point), kmP, CONFIG.PRO.judge(kmP))}
          <div class="hr"></div>
          ${renderBlock("RES", displayName(r.point), kmR, CONFIG.RES.judge(kmR))}
        `;
      } catch (e) {
        out.innerHTML = `<div class="err">${e.message}</div>`;
      }
    }

    document.getElementById("btn").addEventListener("click", run);
    input.addEventListener("keydown", (ev) => { if (ev.key === "Enter") run(); });
  </script>
</body>
</html>
