<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>最近傍点検索</title>
  <style>
    body{font-family:system-ui, sans-serif; max-width:720px; margin:24px auto; padding:0 16px;}
    label{display:block; margin:12px 0 4px;}
    input{width:100%; padding:10px; font-size:16px;}
    button{margin-top:12px; padding:10px 14px; font-size:16px; cursor:pointer;}
    .card{margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:10px;}
    .err{color:#b00020;}
    code{background:#f6f8fa; padding:2px 6px; border-radius:6px;}
  </style>
</head>
<body>
  <h1>最近傍点検索（緯度経度）</h1>

  <label>緯度 (lat)</label>
  <input id="lat" placeholder="例: 35.681236" inputmode="decimal" />

  <label>経度 (lng)</label>
  <input id="lng" placeholder="例: 139.767125" inputmode="decimal" />

  <button id="btn">検索</button>

  <div id="out" class="card" style="display:none;"></div>

  <script>
    const R = 6371000; // meters
    const toRad = (deg) => deg * Math.PI / 180;

    function haversineMeters(lat1, lng1, lat2, lng2) {
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const dφ = toRad(lat2 - lat1);
      const dλ = toRad(lng2 - lng1);
      const a = Math.sin(dφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function parseNum(v) {
      const n = Number(String(v).trim());
      return Number.isFinite(n) ? n : null;
    }

    function validateLatLng(lat, lng) {
      if (lat === null || lng === null) return "緯度経度は数値で入力してね";
      if (lat < -90 || lat > 90) return "緯度は -90〜90";
      if (lng < -180 || lng > 180) return "経度は -180〜180";
      return null;
    }

    async function loadPoints() {
      const res = await fetch("./points.json", { cache: "no-store" });
      if (!res.ok) throw new Error("points.json が読み込めませんでした");
      const pts = await res.json();
      if (!Array.isArray(pts) || pts.length === 0) throw new Error("points.json が空です");
      return pts;
    }

    async function findNearest(lat, lng) {
      const points = await loadPoints();

      let best = null;
      for (const p of points) {
        if (typeof p.lat !== "number" || typeof p.lng !== "number") continue;
        const d = haversineMeters(lat, lng, p.lat, p.lng);
        if (!best || d < best.distance) best = { point: p, distance: d };
      }
      if (!best) throw new Error("有効な候補点がありません");
      return best;
    }

    const out = document.getElementById("out");
    const btn = document.getElementById("btn");

    btn.addEventListener("click", async () => {
      out.style.display = "block";
      out.innerHTML = "計算中…";

      const lat = parseNum(document.getElementById("lat").value);
      const lng = parseNum(document.getElementById("lng").value);

      const err = validateLatLng(lat, lng);
      if (err) {
        out.innerHTML = `<div class="err">${err}</div>`;
        return;
      }

      try {
        const { point, distance } = await findNearest(lat, lng);
        const km = (distance / 1000);

        out.innerHTML = `
          <div><b>最近傍点:</b> ${point.name ?? point.id ?? "(no name)"}</div>
          <div>座標: <code>${point.lat}</code>, <code>${point.lng}</code></div>
          <div>距離: <b>${distance.toFixed(1)} m</b>（${km.toFixed(3)} km）</div>
        `;
      } catch (e) {
        out.innerHTML = `<div class="err">${e.message}</div>`;
      }
    });
  </script>
</body>
</html>
