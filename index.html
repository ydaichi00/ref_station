<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>最近傍点検索（PRO / RES）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; max-width:820px; margin:24px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 10px;}
    .help{color:#555; font-size:14px; margin:0 0 14px; line-height:1.6;}
    .grid{display:grid; grid-template-columns:1fr; gap:12px;}
    @media (min-width: 760px){ .grid{grid-template-columns:1fr 1fr;} }
    .panel{border:1px solid #ddd; border-radius:14px; padding:12px;}
    .panel h2{font-size:16px; margin:0 0 8px;}
    label{display:block; margin:8px 0 6px; font-weight:600;}
    input{width:100%; padding:10px 12px; font-size:16px; border:1px solid #ccc; border-radius:10px;}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{padding:10px 14px; font-size:16px; border:0; border-radius:10px; cursor:pointer;}
    .card{margin-top:16px; padding:12px; border:1px solid #ddd; border-radius:12px;}
    .row{margin:6px 0;}
    .err{color:#b00020; font-weight:700;}
    code{background:#f6f8fa; padding:2px 6px; border-radius:6px;}
    .badge{display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius:999px; font-size:14px; margin-left:6px;}
    .muted{color:#666; font-size:13px;}
    .hr{height:1px; background:#eee; margin:10px 0;}
  </style>
</head>
<body>
  <h1>最近傍点検索（PRO / RES）</h1>
  <p class="help">
    入力形式：<code>35.88446158066726, 139.4528218383903</code>（緯度, 経度）<br/>
    出力：最近接点（都道府県名）＋距離（km）＋判定
  </p>

  <div class="grid">
    <div class="panel">
      <h2>PRO</h2>
      <label for="coordPRO">緯度, 経度</label>
      <input id="coordPRO" placeholder='例: 35.88446158066726, 139.4528218383903' />
      <div class="muted">Enterキーでも検索</div>
      <div class="btnrow">
        <button id="btnPRO">PROで検索</button>
      </div>
    </div>

    <div class="panel">
      <h2>RES</h2>
      <label for="coordRES">緯度, 経度</label>
      <input id="coordRES" placeholder='例: 35.88446158066726, 139.4528218383903' />
      <div class="muted">Enterキーでも検索</div>
      <div class="btnrow">
        <button id="btnRES">RESで検索</button>
      </div>
    </div>
  </div>

  <div class="btnrow" style="margin-top:14px;">
    <button id="btnBoth">PROとRESを両方検索</button>
  </div>

  <div id="out" class="card" style="display:none;"></div>

  <script>
    // =========================
    // PRO/RES 設定（ここだけ触ればOK）
    // =========================
    const CONFIG = {
      PRO: {
        pointsFile: "./PROpoints.json",
        // PRO: <30 ◎ / 30-40(含む) 〇 / 40超-50(含む) 要現地調査 / 50超 非推奨
        judge: (km) => {
          if (km < 30) return "◎";
          if (km <= 40) return "〇";
          if (km <= 50) return "要現地調査";
          return "非推奨";
        }
      },
      RES: {
        pointsFile: "./RESpoints.json",
        // RES: 40以下 ◎ / 50以下 〇 / 50超-60以下 要現地調査 / 60超 非推奨
        judge: (km) => {
          if (km <= 40) return "◎";
          if (km <= 50) return "〇";
          if (km <= 60) return "要現地調査";
          return "非推奨";
        }
      }
    };

    // ===== Core geo =====
    const R = 6371000; // meters
    const toRad = (deg) => deg * Math.PI / 180;

    function haversineMeters(lat1, lng1, lat2, lng2) {
      const φ1 = toRad(lat1), φ2 = toRad(lat2);
      const dφ = toRad(lat2 - lat1);
      const dλ = toRad(lng2 - lng1);
      const a = Math.sin(dφ/2)**2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(dλ/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function parseLatLngLine(s) {
      if (!s) return { lat: null, lng: null, error: "入力が空です" };
      const parts = String(s).trim().split(",");
      if (parts.length !== 2) return { lat: null, lng: null, error: "形式は「緯度, 経度」です（カンマ区切り）" };

      const lat = Number(parts[0].trim());
      const lng = Number(parts[1].trim());
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return { lat: null, lng: null, error: "緯度経度は数値で入力してください" };
      if (lat < -90 || lat > 90) return { lat: null, lng: null, error: "緯度は -90〜90 です" };
      if (lng < -180 || lng > 180) return { lat: null, lng: null, error: "経度は -180〜180 です" };
      return { lat, lng, error: null };
    }

    function formatKm(meters) {
      return (meters / 1000).toFixed(3);
    }

    // ===== Data loading (cached per PRO/RES) =====
    const pointsCache = { PRO: null, RES: null };

    async function loadPoints(which) {
      if (pointsCache[which]) return pointsCache[which];

      const res = await fetch(CONFIG[which].pointsFile, { cache: "no-store" });
      if (!res.ok) throw new Error(`${which}: 候補点ファイルが読み込めませんでした`);
      const pts = await res.json();
      if (!Array.isArray(pts) || pts.length === 0) throw new Error(`${which}: 候補点が空です`);
      pointsCache[which] = pts;
      return pts;
    }

    async function findNearest(which, lat, lng) {
      const points = await loadPoints(which);

      let best = null;
      for (const p of points) {
        if (typeof p.lat !== "number" || typeof p.lng !== "number") continue;
        const d = haversineMeters(lat, lng, p.lat, p.lng);
        if (!best || d < best.distance_m) best = { point: p, distance_m: d };
      }
      if (!best) throw new Error(`${which}: 有効な候補点がありません`);
      return best;
    }

    // ===== UI =====
    const out = document.getElementById("out");
    const inputPRO = document.getElementById("coordPRO");
    const inputRES = document.getElementById("coordRES");

    function renderResultBlock(which, name, km, verdict) {
      return `
        <div class="row"><b>${which} 最近接点:</b> ${name}</div>
        <div class="row"><b>${which} 距離:</b> ${km.toFixed(3)} km <span class="badge">${verdict}</span></div>
      `;
    }

    async function runOne(which) {
      out.style.display = "block";
      out.innerHTML = "計算中…";

      const input = which === "PRO" ? inputPRO : inputRES;
      const parsed = parseLatLngLine(input.value);
      if (parsed.error) {
        out.innerHTML = `<div class="err">${which}: ${parsed.error}</div>`;
        return;
      }

      try {
        const { point, distance_m } = await findNearest(which, parsed.lat, parsed.lng);
        const name = point.name ?? point.pref ?? point.id ?? "(no name)";
        const km = distance_m / 1000;
        const verdict = CONFIG[which].judge(km);

        out.innerHTML = renderResultBlock(which, name, km, verdict);
      } catch (e) {
        out.innerHTML = `<div class="err">${e.message}</div>`;
      }
    }

    async function runBoth() {
      out.style.display = "block";
      out.innerHTML = "計算中…";

      const p = parseLatLngLine(inputPRO.value);
      const r = parseLatLngLine(inputRES.value);

      const errs = [];
      if (p.error) errs.push(`PRO: ${p.error}`);
      if (r.error) errs.push(`RES: ${r.error}`);
      if (errs.length) {
        out.innerHTML = `<div class="err">${errs.join("<br/>")}</div>`;
        return;
      }

      try {
        const [resP, resR] = await Promise.all([
          findNearest("PRO", p.lat, p.lng),
          findNearest("RES", r.lat, r.lng),
        ]);

        const nameP = resP.point.name ?? resP.point.pref ?? resP.point.id ?? "(no name)";
        const kmP = resP.distance_m / 1000;
        const verdictP = CONFIG.PRO.judge(kmP);

        const nameR = resR.point.name ?? resR.point.pref ?? resR.point.id ?? "(no name)";
        const kmR = resR.distance_m / 1000;
        const verdictR = CONFIG.RES.judge(kmR);

        out.innerHTML = `
          ${renderResultBlock("PRO", nameP, kmP, verdictP)}
          <div class="hr"></div>
          ${renderResultBlock("RES", nameR, kmR, verdictR)}
        `;
      } catch (e) {
        out.innerHTML = `<div class="err">${e.message}</div>`;
      }
    }

    document.getElementById("btnPRO").addEventListener("click", () => runOne("PRO"));
    document.getElementById("btnRES").addEventListener("click", () => runOne("RES"));
    document.getElementById("btnBoth").addEventListener("click", runBoth);

    inputPRO.addEventListener("keydown", (ev) => { if (ev.key === "Enter") runOne("PRO"); });
    inputRES.addEventListener("keydown", (ev) => { if (ev.key === "Enter") runOne("RES"); });
  </script>
</body>
</html>
